"use strict";exports.id=3332,exports.ids=[3332],exports.modules={73332:(e,t,n)=>{n.r(t),n.d(t,{default:()=>_});var r=n(45512),a=n(58009),o=n(61425),c=n(30191);async function s(e,t={}){let n;if(t.connector)n=t.connector;else{let{connections:t,current:r}=e.state,a=t.get(r);n=a?.connector}let r=e.state.connections;n&&(await n.disconnect(),n.emitter.off("change",e._internal.events.change),n.emitter.off("disconnect",e._internal.events.disconnect),n.emitter.on("connect",e._internal.events.connect),r.delete(n.uid)),e.setState(e=>{if(0===r.size)return{...e,connections:new Map,current:null,status:"disconnected"};let t=r.values().next().value;return{...e,connections:new Map(r),current:t.connector.uid}});{let t=e.state.current;if(!t)return;let n=e.state.connections.get(t)?.connector;if(!n)return;await e.storage?.setItem("recentConnectorId",n.id)}}var i=n(29945),l=n(81411);let u=[];function d(e){let t=[...e.state.connections.values()];return"reconnecting"===e.state.status||(0,l.b)(u,t)?u:(u=t,t)}var g=n(21663);function f(e,t,n){let r=e[t.name];if("function"==typeof r)return r;let a=e[n];return"function"==typeof a?a:n=>t(e,n)}var y=n(40351),h=n(84126),w=n(53672),m=n(22986),C=n(79941);async function p(e,t={}){let n;let{assertChainId:r=!0}=t;if(t.connector){let{connector:r}=t;if("reconnecting"===e.state.status&&!r.getAccounts&&!r.getChainId)throw new C.HF({connector:r});let[a,o]=await Promise.all([r.getAccounts().catch(e=>{if(null===t.account)return[];throw e}),r.getChainId()]);n={accounts:a,chainId:o,connector:r}}else n=e.state.connections.get(e.state.current);if(!n)throw new C.gC;let a=t.chainId??n.chainId,o=await n.connector.getChainId();if(r&&o!==a)throw new C.xU({connectionChainId:a,connectorChainId:o});let c=n.connector;if(c.getClient)return c.getClient({chainId:a});let s=(0,w.J)(t.account??n.accounts[0]);if(s&&(s.address=(0,m.b)(s.address)),t.account&&!n.accounts.some(e=>e.toLowerCase()===s.address.toLowerCase()))throw new C.aj({address:s.address,connector:c});let i=e.chains.find(e=>e.id===a),l=await n.connector.getProvider({chainId:a});return(0,y.U)({account:s,chain:i,name:"Connector Client",transport:e=>(0,h.I)(l)({...e,retryCount:0})})}async function v(e,t){let{account:n,connector:r,...a}=t;return f("object"==typeof n&&"local"===n.type?e.getClient():await p(e,{account:n,connector:r}),g.l,"signMessage")({...a,...n?{account:n}:{}})}var b=n(24761);async function I(e,t){let{account:n,chainId:r,connector:a,...o}=t,c=f("object"==typeof n&&n?.type==="local"?e.getClient({chainId:r}):await p(e,{account:n??void 0,assertChainId:!1,chainId:r,connector:a}),b.v,"sendTransaction");return await c({...o,...n?{account:n}:{},chain:r?{id:r}:null,gas:o.gas??void 0})}n(49361);var S=n(42784);let k="__glyph-widget-token__",E="__glyph-widget-nonce__",A=(0,S.c)("EIP1193Strategy"),_=({children:e,glyphUrl:t,onLogin:n,onLogout:u,askForSignature:g=!0})=>{let[f,y]=(0,a.useState)(!1),[h,w]=(0,a.useState)(null),{address:m,isConnected:C,chainId:p}=(0,o.F)(),{disconnectAsync:b}=function(e={}){let{mutation:t}=e,n=(0,i.U)(e),{mutate:r,mutateAsync:o,...u}=(0,c.n)({...t,mutationFn:e=>s(n,e),mutationKey:["disconnect"]});return{...u,connectors:(function(e={}){let t=(0,i.U)(e);return(0,a.useSyncExternalStore)(e=>(function(e,t){let{onChange:n}=t;return e.subscribe(()=>d(e),n,{equalityFn:l.b})})(t,{onChange:e}),()=>d(t),()=>d(t))})({config:n}).map(e=>e.connector),disconnect:r,disconnectAsync:o}}(),{signMessageAsync:_}=function(e={}){var t;let{mutation:n}=e,r=(t=(0,i.U)(e),{mutationFn:e=>v(t,e),mutationKey:["signMessage"]}),{mutate:a,mutateAsync:o,...s}=(0,c.n)({...n,...r});return{...s,signMessage:a,signMessageAsync:o}}(),{sendTransactionAsync:x}=function(e={}){var t;let{mutation:n}=e,r=(t=(0,i.U)(e),{mutationFn:e=>I(t,e),mutationKey:["sendTransaction"]}),{mutate:a,mutateAsync:o,...s}=(0,c.n)({...n,...r});return{...s,sendTransaction:a,sendTransactionAsync:o}}();A.log({address:m,isConnected:C});let[F,U]=(0,a.useState)(()=>{if(typeof window>"u")return null;try{return localStorage.getItem(k)}catch(e){return A.warn("Error reading session token",e),null}}),[M,j]=(0,a.useState)(null),[T,P]=(0,a.useState)(()=>{if(typeof window>"u")return null;try{return localStorage.getItem(E)}catch(e){return A.warn("Error reading session nonce",e),null}});(0,a.useEffect)(()=>{try{F&&T?(localStorage.setItem(k,F),localStorage.setItem(E,T)):(localStorage.removeItem(k),localStorage.removeItem(E))}catch(e){A.error("Error saving session token",e)}},[T,F]);let W=(0,a.useCallback)(async e=>{try{return await fetch(`${t||S.W}/api/widget/auth/message/${e}`).then(e=>e.json())}catch(e){throw A.error("Can't fetch message to sign",e),Error("Failed to fetch the message to sign.")}},[t]),L=(0,a.useCallback)(async(e,n,r)=>{try{return await fetch(`${t||S.W}/api/widget/auth/verify/${e}`,{method:"POST",body:JSON.stringify({signature:n,nonce:r})}).then(e=>e.json())}catch(e){throw A.error("Can't verify signature",e),Error("Signature verification failed.")}},[t]);(0,a.useEffect)(()=>{m&&C&&!T&&(y(!0),W(m).then(({message:e,nonce:t})=>{j(e),P(t),y(!1)}).finally(()=>{y(!1)}))},[m,C,W,T]),(0,a.useEffect)(()=>{if(!F||!T)return;let e=(0,S.b)(t||S.W,async()=>F,{"x-evm-address":m,"x-glyph-nonce":T});w(()=>e)},[F,m,t,T]);let $=(0,a.useCallback)(async()=>{await b()},[b]),q=(0,a.useCallback)(async()=>{if(A.log("authenticate"),!m){A.error("no wallet connected.");return}try{if(!m||!C||!M||!T){w(null),y(!1);return}y(!0);let e=await _({account:m,message:M});console.log(T,M,e);let t=(await L(m,e,T))?.token;U(t)}catch(e){A.error("Authentication failed",e),e?.message?.toLowerCase?.().includes?.("user rejected")||await alert("Authentication failed - your browser could be blocking the popups. Allow popups or try to manually click sign in."),w(null),U(null),P(null)}finally{y(!1),n?.()}},[m,C,M,T,_,L]),K=(0,a.useCallback)(async()=>{P(null),U(null),y(!1),w(null),u?.()},[]),J=(0,a.useCallback)(async({message:e})=>{if(!m||!C)throw Error("Wallet not connected");return _({account:m,message:e})},[m,C,_]),O=(0,a.useCallback)(async({transaction:e})=>{if(!m||!C)throw Error("Wallet not connected");return x({...e,chainId:p||S.d.id})},[m,C,x,p]),[z,D]=(0,a.useState)(!1);return function(e={}){let{onConnect:t,onDisconnect:n}=e;(0,i.U)(e)}({onConnect:()=>{g&&D(!0)},onDisconnect:()=>{K()}}),(0,a.useEffect)(()=>{g&&C&&m&&z&&T&&M&&(q(),D(!1))},[C,m,q,z,T,M,g]),(0,r.jsx)(S.a.Provider,{value:{ready:!f&&!!T,authenticated:C&&!!m&&null!==F,glyphUrl:t,hideWidget:!C||!m,login:q,logout:$,signMessage:J,sendTransaction:O,apiFetch:h},children:e})}},84126:(e,t,n)=>{n.d(t,{I:()=>a});var r=n(93253);function a(e,t={}){let{key:n="custom",methods:o,name:c="Custom Provider",retryDelay:s}=t;return({retryCount:a})=>(0,r.o)({key:n,methods:o,name:c,request:e.request.bind(e),retryCount:t.retryCount??a,retryDelay:s,type:"custom"})}}};