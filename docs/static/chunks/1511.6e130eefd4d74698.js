"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1511],{1511:(e,t,n)=>{n.r(t),n.d(t,{default:()=>F});var a=n(95155),o=n(12115),r=n(35965),c=n(25848);async function s(e,t={}){let n;if(t.connector)n=t.connector;else{let{connections:t,current:a}=e.state,o=t.get(a);n=o?.connector}let a=e.state.connections;n&&(await n.disconnect(),n.emitter.off("change",e._internal.events.change),n.emitter.off("disconnect",e._internal.events.disconnect),n.emitter.on("connect",e._internal.events.connect),a.delete(n.uid)),e.setState(e=>{if(0===a.size)return{...e,connections:new Map,current:null,status:"disconnected"};let t=a.values().next().value;return{...e,connections:new Map(a),current:t.connector.uid}});{let t=e.state.current;if(!t)return;let n=e.state.connections.get(t)?.connector;if(!n)return;await e.storage?.setItem("recentConnectorId",n.id)}}var i=n(57342),l=n(36919);let u=[];function d(e){let t=[...e.state.connections.values()];return"reconnecting"===e.state.status||(0,l.b)(u,t)?u:(u=t,t)}var g=n(87027);function f(e,t,n){let a=e[t.name];if("function"==typeof a)return a;let o=e[n];return"function"==typeof o?o:n=>t(e,n)}var h=n(44711),y=n(77271),w=n(98722),m=n(40814),v=n(22537);async function C(e,t={}){let n;let{assertChainId:a=!0}=t;if(t.connector){let{connector:a}=t;if("reconnecting"===e.state.status&&!a.getAccounts&&!a.getChainId)throw new v.HF({connector:a});let[o,r]=await Promise.all([a.getAccounts().catch(e=>{if(null===t.account)return[];throw e}),a.getChainId()]);n={accounts:o,chainId:r,connector:a}}else n=e.state.connections.get(e.state.current);if(!n)throw new v.gC;let o=t.chainId??n.chainId,r=await n.connector.getChainId();if(a&&r!==o)throw new v.xU({connectionChainId:o,connectorChainId:r});let c=n.connector;if(c.getClient)return c.getClient({chainId:o});let s=(0,w.J)(t.account??n.accounts[0]);if(s&&(s.address=(0,m.b)(s.address)),t.account&&!n.accounts.some(e=>e.toLowerCase()===s.address.toLowerCase()))throw new v.aj({address:s.address,connector:c});let i=e.chains.find(e=>e.id===o),l=await n.connector.getProvider({chainId:o});return(0,h.U)({account:s,chain:i,name:"Connector Client",transport:e=>(0,y.I)(l)({...e,retryCount:0})})}async function p(e,t){let{account:n,connector:a,...o}=t;return f("object"==typeof n&&"local"===n.type?e.getClient():await C(e,{account:n,connector:a}),g.l,"signMessage")({...o,...n?{account:n}:{}})}var b=n(20445);async function I(e,t){let{account:n,chainId:a,connector:o,...r}=t,c=f("object"==typeof n&&n?.type==="local"?e.getClient({chainId:a}):await C(e,{account:n??void 0,assertChainId:!1,chainId:a,connector:o}),b.v,"sendTransaction");return await c({...r,...n?{account:n}:{},chain:a?{id:a}:null,gas:r.gas??void 0})}var S=n(12443),k=n(21833);let E="__glyph-widget-token__",_="__glyph-widget-nonce__",A=(0,k.c)("EIP1193Strategy"),F=({children:e,glyphUrl:t,onLogin:n,onLogout:u,askForSignature:g=!0})=>{let[f,h]=(0,o.useState)(!1),[y,w]=(0,o.useState)(null),{address:m,isConnected:v,chainId:C}=(0,r.F)(),{disconnectAsync:b}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{mutation:t}=e,n=(0,i.U)(e),{mutate:a,mutateAsync:r,...u}=(0,c.n)({...t,mutationFn:e=>s(n,e),mutationKey:["disconnect"]});return{...u,connectors:(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,i.U)(e);return(0,o.useSyncExternalStore)(e=>(function(e,t){let{onChange:n}=t;return e.subscribe(()=>d(e),n,{equalityFn:l.b})})(t,{onChange:e}),()=>d(t),()=>d(t))})({config:n}).map(e=>e.connector),disconnect:a,disconnectAsync:r}}(),{signMessageAsync:F}=function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{mutation:n}=t,a=(e=(0,i.U)(t),{mutationFn:t=>p(e,t),mutationKey:["signMessage"]}),{mutate:o,mutateAsync:r,...s}=(0,c.n)({...n,...a});return{...s,signMessage:o,signMessageAsync:r}}(),{sendTransactionAsync:U}=function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{mutation:n}=t,a=(e=(0,i.U)(t),{mutationFn:t=>I(e,t),mutationKey:["sendTransaction"]}),{mutate:o,mutateAsync:r,...s}=(0,c.n)({...n,...a});return{...s,sendTransaction:o,sendTransactionAsync:r}}();A.log({address:m,isConnected:v});let[M,j]=(0,o.useState)(()=>{if(typeof window>"u")return null;try{return localStorage.getItem(E)}catch(e){return A.warn("Error reading session token",e),null}}),[T,x]=(0,o.useState)(null),[P,W]=(0,o.useState)(()=>{if(typeof window>"u")return null;try{return localStorage.getItem(_)}catch(e){return A.warn("Error reading session nonce",e),null}});(0,o.useEffect)(()=>{try{M&&P?(localStorage.setItem(E,M),localStorage.setItem(_,P)):(localStorage.removeItem(E),localStorage.removeItem(_))}catch(e){A.error("Error saving session token",e)}},[P,M]);let L=(0,o.useCallback)(async e=>{try{return await fetch(`${t||k.W}/api/widget/auth/message/${e}`).then(e=>e.json())}catch(e){throw A.error("Can't fetch message to sign",e),Error("Failed to fetch the message to sign.")}},[t]),$=(0,o.useCallback)(async(e,n,a)=>{try{return await fetch(`${t||k.W}/api/widget/auth/verify/${e}`,{method:"POST",body:JSON.stringify({signature:n,nonce:a})}).then(e=>e.json())}catch(e){throw A.error("Can't verify signature",e),Error("Signature verification failed.")}},[t]);(0,o.useEffect)(()=>{m&&v&&!P&&(h(!0),L(m).then(({message:e,nonce:t})=>{x(e),W(t),h(!1)}).finally(()=>{h(!1)}))},[m,v,L,P]),(0,o.useEffect)(()=>{if(!M||!P)return;let e=(0,k.b)(t||k.W,async()=>M,{"x-evm-address":m,"x-glyph-nonce":P});w(()=>e)},[M,m,t,P]);let q=(0,o.useCallback)(async()=>{await b()},[b]),K=(0,o.useCallback)(async()=>{if(A.log("authenticate"),!m){A.error("no wallet connected.");return}try{if(!m||!v||!T||!P){w(null),h(!1);return}h(!0);let e=await F({account:m,message:T});console.log(P,T,e);let t=(await $(m,e,P))?.token;j(t)}catch(e){A.error("Authentication failed",e),e?.message?.toLowerCase?.().includes?.("user rejected")||await alert("Authentication failed - your browser could be blocking the popups. Allow popups or try to manually click sign in."),w(null),j(null),W(null)}finally{h(!1),n?.()}},[m,v,T,P,F,$]),N=(0,o.useCallback)(async()=>{W(null),j(null),h(!1),w(null),u?.()},[]),J=(0,o.useCallback)(async({message:e})=>{if(!m||!v)throw Error("Wallet not connected");return F({account:m,message:e})},[m,v,F]),O=(0,o.useCallback)(async({transaction:e})=>{if(!m||!v)throw Error("Wallet not connected");return U({...e,chainId:C||k.d.id})},[m,v,U,C]),[z,D]=(0,o.useState)(!1);return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{onConnect:t,onDisconnect:n}=e,a=(0,i.U)(e);(0,o.useEffect)(()=>(0,S.F)(a,{onChange(e,a){if(("reconnecting"===a.status||"connecting"===a.status&&void 0===a.address)&&"connected"===e.status){let{address:n,addresses:o,chain:r,chainId:c,connector:s}=e,i="reconnecting"===a.status||void 0===a.status;null==t||t({address:n,addresses:o,chain:r,chainId:c,connector:s,isReconnected:i})}else"connected"===a.status&&"disconnected"===e.status&&(null==n||n())}}),[a,t,n])}({onConnect:()=>{g&&D(!0)},onDisconnect:()=>{N()}}),(0,o.useEffect)(()=>{g&&v&&m&&z&&P&&T&&(K(),D(!1))},[v,m,K,z,P,T,g]),(0,a.jsx)(k.a.Provider,{value:{ready:!f&&!!P,authenticated:v&&!!m&&null!==M,glyphUrl:t,hideWidget:!v||!m,login:K,logout:q,signMessage:J,sendTransaction:O,apiFetch:y},children:e})}},77271:(e,t,n)=>{n.d(t,{I:()=>o});var a=n(67128);function o(e,t={}){let{key:n="custom",methods:r,name:c="Custom Provider",retryDelay:s}=t;return({retryCount:o})=>(0,a.o)({key:n,methods:r,name:c,request:e.request.bind(e),retryCount:t.retryCount??o,retryDelay:s,type:"custom"})}}}]);